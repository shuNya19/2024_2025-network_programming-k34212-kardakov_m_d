University: [ITMO University](https://itmo.ru/ru/)  
Faculty: [FICT](https://fict.itmo.ru)  
Course: [Network programming](https://github.com/itmo-ict-faculty/network-programming)  
Year: 2024/2025  
Group: K34212  
Author: Kardakov Maxim Dmitrievich  
Lab: Lab4  
Date of create: 24.02.2024  
Date of finished: 24.02.2024 

## Отчёт о Лабораторной работе №4 <br>"Базовая 'коммутация' и туннелирование используя язык программирования P4"

### Описание работы

В данной лабораторной работе вы познакомитесь на практике с языком программирования P4, разработанным компанией Barefoot (ныне Intel) для организации процесса обработки сетевого трафика на скорости чипа. Barefoot разработал несколько FPGA-чипов для обработки трафика, которые были встроены в некоторые модели коммутаторов Arista и Brocade.

### Цель работы

Изучить синтаксис языка программирования P4 и выполнить два обучающих задания от Open Networking Foundation для ознакомления с практическим применением P4.

### Ход работы

#### 1. Изучение основ языка программирования P4

Перед выполнением заданий был изучен документ [P4_16 Language Specification](https://p4.org/p4-spec/docs/P4-16-v1.2.4.html), который дал базовое представление о структуре и синтаксисе языка P4. Основные элементы, такие как заголовки (headers), парсеры (parsers), действия (actions), таблицы (tables) и депарсеры (deparsers), были рассмотрены для подготовки к реализации заданий.

Для выполнения работы была подготовлена тестовая среда:
1. Установлены VirtualBox и Vagrant на Windows 11.
2. Склонирован репозиторий `p4lang/tutorials` с помощью команды `git clone https://github.com/p4lang/tutorials.git`
3. Развёрнута виртуальная машина Ubuntu 20.04 через Vagrant:<br/>

   ```bash
   cd tutorials/vm-ubuntu-20.04
   vagrant up
   
После этого я получил доступ к виртуальной машине с аккаунтами vagrant/vagrant и p4/p4.

### 2. Реализация задания "Implementing Basic Forwarding"

Цель этого задания — написать программу на P4 для базовой пересылки IPv4-пакетов. Коммутатор должен:<br/>
- Обновлять MAC-адреса источника и назначения.
- Уменьшать TTL в IP-заголовке.
- Пересылать пакет через соответствующий порт.

#### Этапы выполнения:  
**1. Анализ исходного кода**<br/><br/>
Исходный файл basic.p4 содержал скелет программы, который изначально отбрасывал все пакеты. Моя задача — доработать его для поддержки IPv4-маршрутизации. 
При первой же попытке выполнить make run, у меня возникла ошибка: конфигурационный файл Makefile ссылался на файл с расширеним .txtpb, хотя искомый файл имел расширение .txt. Пришлось немного побегать по директориям, переписать все обращение к этому файлу и в итоге make run был выполнен успешно.  
Результат пинга с изначальным билдом представлен ниже<br/><br/>
<img src="https://github.com/user-attachments/assets/97acb469-c76c-4ed4-98e7-41a1084ade7a" alt="" width="300"/><br/><br/>
**2. Обновление парсера**<br/><br/>
Парсер был модифицирован для извлечения заголовков Ethernet и IPv4<br/><br/>
<img src="https://github.com/user-attachments/assets/15511104-ad7b-4c9f-a96e-56c49184cbbf" alt="" width="600"/><br/><br/>
**3. Реализация действия ipv4_forward**<br/><br/>
Было добавлено действие для пересылки пакетов<br/><br/>
<img src="https://github.com/user-attachments/assets/b2b59ca5-2a4d-4688-96f9-0425244ff5db" alt="" width="600"/><br/><br/>
**4. Обновление логики MyIngress**<br/><br/>
Была добавлена проверка валидности IPv4-заголовка<br/><br/>
<img src="https://github.com/user-attachments/assets/5a062580-3cbc-4231-b69b-9e4bc86e3238" alt="" width="400"/><br/><br/>
**5. Обновление депарсера**<br/><br/>
Депарсер был настроен на отправку заголовков в правильном порядке<br/><br/>
<img src="https://github.com/user-attachments/assets/f7438e8a-af48-4b19-a8ad-65973e887eeb" alt="" width="600"/><br/><br/>
**6. Тестирование**<br/><br/>
Файл basic.p4 был перезаписан, после чего были выполнены команды: 
```bash
   make stop
   make clean
   make build
   make run
```
В mininet была выполнена команда pingall. Программа успешно пересылала IPv4-пакеты между хостами, что подтверждено результатами пингов.<br/><br/>
<img src="https://github.com/user-attachments/assets/c4f37024-c931-4b60-b964-15983ba5c595" alt="" width="400"/>  

### 3. Реализация задания "Implementing Basic Tunneling"  

Цель этого задания — добавить поддержку туннелирования к маршрутизатору IPv4, используя новый заголовок myTunnel_t для маршрутизации по полю dst_id.  

#### Этапы выполнения:  
**1. Анализ исходного кода** <br/>
Файл basic_tunnel.p4 содержал реализацию маршрутизатора из предыдущего задания с добавленным заголовком myTunnel_t.<br/><br/>
**2. Обновление парсера** <br/><br/>
<img src="https://github.com/user-attachments/assets/b92b154a-c263-4daf-ab2d-d95c8f3e2a24" alt="" width="600"/><br/><br/>
**3. Добавление действия myTunnel_forward и создание таблицы myTunnel_exact** <br/><br/>
<img src="https://github.com/user-attachments/assets/f0ac9918-1184-4e5c-8f83-2b6bc6eb81d0" alt="" width="400"/><br/><br/>
**4. Обновление логики MyIngress** <br/>
``` p4
apply {
    if (hdr.myTunnel.isValid()) {
        myTunnel_exact.apply();
    } else if (hdr.ipv4.isValid()) {
        ipv4_lpm.apply();
    }
}
```
**5. Обновление депарсера** <br/><br/>
<img src="https://github.com/user-attachments/assets/8ce64d4b-958e-4488-8004-b2e7db99f030" alt="" width="600"/><br/><br/>
**6. Тестирование** <br/><br/>
Была выполнена компицляция и запуск командой `make run`, после чего были открыты терминалы для h1 и h2: `xterm h1 h2`. До этого я выполнял всё через SSH, но для удобства переключился на графический интерфейс.<br/><br/>
**Проверка без туннелирования** <br/><br/>
На h2 был запущен файл ```./recieve.py```, чтобы он выводил в консоль все приходящие пакеты. В тот же момент на h1 был отправлен пакет: `./send.py 10.0.2.2 "P4 is cool"`.  
Как мы можем видеть, сообщение было успешно передано.<br/><br/>
<img src="https://github.com/user-attachments/assets/a7200a50-92b4-4f8e-8498-86a7df73e881" alt="" width="400"/><br/><br/>
**Проверка с туннелированием** <br/><br/>
На h2 всё так же выполнялся `./recieve.py`, а на h1 была выполнена команда `./send.py 10.0.2.2 "P4 is cool" --dst_id 2`, то есть и IP и dst_id соответствовал h2<br/><br/>
<img src="https://github.com/user-attachments/assets/7daf2b43-bc15-453c-a0c8-59163b5d33f5" alt="" width="400"/><br/><br/>
Далее была выполнена строка `./send.py 10.0.3.3 "P4 is cool" --dst_id 2`. Несмотря на то, что IP был указан от h3, из-за маршрутизации по dst_id 2 сообщение было передано всё так же на h2<br/><br/>
<img src="https://github.com/user-attachments/assets/b2374357-12f3-4071-a6e7-2757d2edf547" alt="" width="400"/><br/>

### Выводы  
В ходе данной лабораторной работы были изучены основы языка P4, освоена настройка виртуальной среды для разработки, а также реализована базовая пересылка IPv4-пакетов и туннелирование с использованием пользовательского заголовка.
